---
- name: Bootstrap the master and worker nodes
  become: true
  hosts: [master_nodes, worker_nodes]

  tasks:
    - name: Install system packages
      apt:
        pkg:
          - software-properties-common
          - python3-pip
          - virtualenv
          - python3-setuptools
          - samba
          - net-tools
          - docker.io
        state: latest
        update_cache: true
    
    - name: Add K8s GPG key
      apt_key:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        
        state: present

    - name: Add k8s repo
      apt_repository:
        repo: deb http://apt.kubernetes.io/ kubernetes-xenial main
        state: present


    - name: Install K8s
      apt:
        pkg:
          - kubeadm
          - kubelet
          - kubectl
        state: latest
        update_cache: true


    - name: Hold k8s packages
      dpkg_selections:
        name:
          - kubeadm
          - kubelet
          - kubectl
        selection: hold

    - name: Make sure docker uses correct cgroup driver
      copy:
        src: templates/daemon.json
        dest: /etc/docker/daemon.json
        remote_src: yes
        owner: k8s
        mode: '0755'
        group: k8s

    - name: Restart docker service
      service:
        name: docker
        state: restarted
      
    - name: Create home directory
      file:
        path: "/home/k8s/.kube"
        state: directory

    - name: Remove dependencies that are no longer required
      apt:
        autoremove: yes

################################
################################
################################

- name: Configure master nodes
  become: true
  hosts: [master_nodes]
  tasks:

    - name: Create bootstrap dir to store configs
      file:
        path: "/home/k8s/.bootstrap"
        state: directory

   - name: Copy kube-config
      copy:
        src: templates/kube-config.yaml
        dest: /home/k8s/.bootstrap/kube-config.yaml
        remote_src: yes
        owner: k8s
        mode: '0755'
        group: k8s
    
    - name: Copy calico config
      copy:
        src: templates/calico.yaml
        dest: /home/k8s/.bootstrap/calico.yaml
        remote_src: yes
        owner: k8s
        mode: '0755'
        group: k8s

  - name: Init master
    shell: kubeadm init --config /home/k8s/.bootstrap/kube-config.yaml
  
  - name: Copy kubectl config
    copy: 
      src: /etc/kubernetes/admin.conf
      dest: /home/k8s/.kube/config
      owner: k8s
      group: k8s
      remote_src: yes

  - name: Fetch kubectl config
    fetch:
      src: /home/k8s/.kube/config
      dest: .kube/config
      flat: yes

  - name: Install calico CNI
    shell: kubectl apply -f /home/k8s/calico.yaml