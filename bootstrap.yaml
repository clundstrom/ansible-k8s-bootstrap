---
- name: Setup system packages
  become: true
  hosts: post_config_master

  tasks:
    - name: Install system packages
      apt:
        pkg:
          - software-properties-common
          - python3-pip
          - virtualenv
          - python3-setuptools
          - samba
          - net-tools
          - docker.io
        state: latest
        update_cache: true
    
    - name: Add K8s GPG key
      apt_key:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        
        state: present

    - name: Add k8s repo
      apt_repository:
        repo: deb http://apt.kubernetes.io/ kubernetes-xenial main
        state: present


    - name: Install K8s
      apt:
        pkg:
          - kubeadm
          - kubelet
          - kubectl
        state: latest
        update_cache: true


    - name: Hold k8s packages
      dpkg_selections:
        name:
          - kubeadm
          - kubelet
          - kubectl
        selection: hold

    - name: Copy authorized_keys from default account to new user
      copy:
        src: templates/daemon.json
        dest: /etc/docker/daemon.json
        remote_src: no
        owner: k8s
        mode: '0755'
        group: k8s
      
    - name: Remove dependencies that are no longer required
      apt:
        autoremove: yes
    
    
        